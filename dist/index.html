<html>
    <head>
        <title>Simple Free Encryption Tool</title>
        <link rel="stylesheet" href="css/toastr.min.css" />

        <script src="js/jquery-3.1.1.min.js"></script>
        
        <script src="js/windowSfet.js"></script>

        <script src="js/toastr.min.js"></script>

        <script language="javascript">
            var keys = {};

            function hashMD5(){
                var plaintext = $('#md5Plaintext').val();
                var hash = sfet.md5.hash(plaintext);
                $('#md5Hash').val(hash);
                toastr.success('MD5 hash generated');
            }

            function generateKeys(){
                toastr.info('generating keys');
                setTimeout(()=> {
                    keys = sfet.rsa.generateKeysSync($('#keySize').val());
                    toastr.success(keys.keySize + '-bit keys generated in ' + keys.time + 'ms');
                    $('#rsaPublicKey').val(keys.public);
                    $('#rsaPrivateKey').val(keys.private);
                }, 750);
            }

            function updateRSAKeys(){
                keys.public = $('#rsaPublicKey').val();
                keys.private = $('#rsaPrivateKey').val();
                toastr.success('RSA keys updated');
            }

            function encryptRSA() {
                if (!keys || !keys.public || keys.public.length == 0){
                    return toastr.error('RSA Public Key required');
                }
                var plaintext = $('#rsaPlaintext').val();
                try {
                    var encrypted = sfet.rsa.encrypt(keys.public, plaintext);
                    $('#rsaEncryptedText').val(encrypted);
                    toastr.success('RSA encryption successful');
                } catch (error){
                    toastr.error(error.message);
                }
            }

            function decryptRSA() {
                if (!keys || !keys.private || keys.private.length == 0){
                    return toastr.error('RSA Private Key required');
                }
                var encrypted = $('#rsaEncryptedText').val();
                try {
                    var decrypted = sfet.rsa.decrypt(keys.private, encrypted);
                    $('#rsaPlaintext').val(decrypted);
                    toastr.success('RSA decryption successful');
                } catch (error){
                    toastr.error(error.message);
                }
            }

            function generateRandomKey(){
                $('#aesKey').val(
                    sfet.aes.generateKey()
                );
            }

            function generateIv() {
                $('#aesIv').val(
                    sfet.aes.generateIv()
                );
            }

            function encryptAESText() {
                var key = $('#aesKey').val();
                var iv = $('#aesIv').val();
                if (iv.length == 0) iv = null;
                var plaintext = $('#aesPlaintext').val();
                try {
                    var encrypted = sfet.aes.encrypt(key, plaintext, iv);
                    $('#aesEncryptedText').val(encrypted);
                    toastr.success('AES encryption successful');
                } catch (error){
                    toastr.error(error.message);
                }
            }

            function decryptAESText() {
                var key = $('#aesKey').val();
                var iv = $('#aesIv').val();
                if (iv.length == 0) iv = null;
                var encrypted = $('#aesEncryptedText').val();
                try {
                    var decrypted = sfet.aes.decrypt(key, encrypted, iv);
                    $('#aesPlaintext').val(decrypted);
                    toastr.success('AES decryption successful');
                } catch (error){
                    toastr.error(error.message);
                }
            }

            function showAesSelectedOptions(){
                var selected = $('#aesSelector').val();
                switch (selected){
                    case "file":
                        $('.aesTextOptions').hide();
                        $('.aesFileOptions').show();
                        break;
                    case "text":
                        $('.aesTextOptions').show();
                        $('.aesFileOptions').hide();
                        break;    
                }
            }

            function encryptAESFile(){
                var key = $('#aesKey').val();
                var iv = $('#aesIv').val();
                if (iv.length == 0) iv = null;
                var filename = $('#aesSourceFile').val();
                if (!filename || filename.length == 0){
                    return toastr.error('Source file must be specified');
                }

                $('#aesResultFile').hide();

                // load file contents into base64
                var reader = new FileReader();
                var file = $('#aesSourceFile')[0].files[0];
                reader.readAsDataURL(file);
                reader.onload = function () {
                    // strip metadata, encrypt the rest, then reattach
                    var contentIndex = reader.result.indexOf('base64,') + 'base64'.length + 1;
                    var metadata = reader.result.substr(0, contentIndex);
                    var content = reader.result.substr(contentIndex);

                    try {
                        $('#aesResultFile').attr(
                            'href',
                            metadata + sfet.aes.encrypt(key, content, iv)
                        );

                        // get filename from (fake) full path
                        var strippedFilename = filename.replace(/^.*[\\\/]/, '');
                        $('#aesResultFile').attr(
                            'download',
                            strippedFilename + '.encrypted'
                        );

                        toastr.success('AES encryption successful');
                        $('#aesResultFile').show();
                    } catch (error){
                        toastr.error(error.message);
                    }
                };
                reader.onerror = function (error) {
                    return toastr.error(error);
                };                
            }

            function decryptAESFile(){
                var key = $('#aesKey').val();
                var iv = $('#aesIv').val();
                if (iv.length == 0) iv = null;
                var filename = $('#aesSourceFile').val();
                if (!filename || filename.length == 0){
                    return toastr.error('Source file must be specified');
                }

                $('#aesResultFile').hide();

                // load file contents into base64
                var reader = new FileReader();
                var file = $('#aesSourceFile')[0].files[0];
                reader.readAsDataURL(file);
                reader.onload = function () {
                    // strip metadata, decrypt the rest, then reattach
                    var contentIndex = reader.result.indexOf('base64,') + 'base64'.length + 1;
                    var metadata = reader.result.substr(0, contentIndex);
                    var content = reader.result.substr(contentIndex);

                    try {
                        $('#aesResultFile').attr(
                            'href',
                            metadata + sfet.aes.decrypt(key, content, iv)
                        );

                        // get filename from (fake) full path
                        var strippedFilename = filename.replace(/^.*[\\\/]/, '');
                        // remove '.encrypted' extension if it's there
                        var encryptedExtensionIndex = strippedFilename.lastIndexOf('.encrypted');
                        if (encryptedExtensionIndex >= 0) {
                            strippedFilename = strippedFilename.substr(0, encryptedExtensionIndex);
                        }
                        $('#aesResultFile').attr(
                            'download',
                            strippedFilename
                        );

                        toastr.success('AES decryption successful');
                        $('#aesResultFile').show();
                    } catch (error){
                        toastr.error(error.message);
                    }
                };
                reader.onerror = function (error) {
                    return toastr.error(error);
                };                
            }

            // Call this code when the page is done loading.
            $(function () {
                // Check for the various File API support.
                if (window.File && window.FileReader && window.FileList && window.Blob) {
                    console.log('file handling available');
                    $('#aesSelectorDiv').html(
                        '<br /><select id="aesSelector">' +
                        '<option value="text">Text</option>' +
                        '<option value="file">Binary File</option>' +
                        '</select>'
                    );
                    $('#aesSelector').change(() => {
                        showAesSelectedOptions();
                    });
                    showAesSelectedOptions();

                    $('#aesSourceFile').change(() => {
                        $('#aesResultFile').hide();
                    });
                    $('#aesResultFile').hide();
                } else {
                    console.log('file handling not available');
                }
            });
        </script>
        <style>
            textarea {
                width: 250px;
                height: 75px;
            }
        </style>
    </head>
    <body>
        <center>
        <div style="width:500px;">
        <h1>Simple Free Encryption Tool</h1>
        <b>Simple Free Encryption Tool (sfet)</b> uses RSA and AES versions that are strong and allow
        encryption between client-side Javascript, Node.js and C#.
        <br />
        <br />
        Open and free for all to see, can be run stand-alone for extra security,
        <br />
        see <a href="https://github.com/therightstuff/simple-free-encryption-tool" target="_blank">https://github.com/therightstuff/simple-free-encryption-tool</a>
        <br />
        <br />
        <b><u>Encryption 101</u></b>:
        <br />
            RSA encryption operates on a very limited string length, it is generally used to asymmetrically
            encrypt a shared secret that in turn is used for symmetric encryption. The standard use-case is
            to generate a random shared secret and transmit it encrypted with the destination's public RSA
            key. Once the destination has decrypted the shared secret with its private RSA key both sides
            will be able to use that secret to encrypt and decrypt communication with AES.
        <br />
        <br />
        <b><u>Important Quirks</u></b>:
        <br />
            The AES secret must be a 32 character string. In order to ensure a valid string, the secret is
            hashed using the MD5 algorithm to produce a string of the correct length.
            <br />
            <br />        
            The IV, or Initialization Vector, is a 16 character hexadecimal string that's required by the AES algorithm
            (<a href="https://crypto.stackexchange.com/questions/3965/what-is-the-main-difference-between-a-key-an-iv-and-a-nonce" target="_blank">read this for a detailed explanation</a>).
            It's not really necessary when encryption secrets aren't being reused, but as it's enforced by
            the underlying crypto package it's recommended to include it. If you do choose to leave it out,
            a default IV of '0000000000000000' will be used.
        <br />
        <br />
        <b><u>File Encryption</u></b>:
        <br />
            If your browser supports it, you will be able to encrypt and decrypt files from this interface.
            The file metadata (eg. MIME type) will not be encrypted, only the file contents.
        </div>
        <h2>MD5</h2>
        <table>
            <tr>
                <td colspan="2" align="center"><button onclick="hashMD5()">Hash!</button></td>
            </tr>
            <tr>
                <td>Initial text</td>
                <td>MD5 Hash</td>
            </tr>
            <tr>
                <td><textarea id="md5Plaintext"></textarea></td>
                <td><input id="md5Hash" size="40" style="text-align: center" /></td>
            </tr>
        </table>

        <h2>RSA</h2>
        <div>
            RSA Keys generated with PKCS1 padding, OPENSSH PEM format is compatible with C#.
            <br />
            <ul>C# counterparts:
                <li><a href="https://gist.github.com/therightstuff/aa65356e95f8d0aae888e9f61aa29414" target="_blank">key importer / exporter</a></li>
                <li><a href="https://gist.github.com/therightstuff/4db89368887dba2fe8935b2fb329f5aa" target="_blank">encrypt / decrypt functions</a></li>
            </ul>
        </div>
        <table>
            <tr>
                <td colspan="2" align="center"><select id="keySize">
                    <option value="2048" selected="selected">2048</option>
                    <option value="4096">4096</option>
                </select>-bit <button onclick="generateKeys()">Generate New Key Pair!</button></td>
            </tr>
            <tr>
                <td>Public Key</td>
                <td>Private Key</td>
            </tr>
            <tr>
                <td><textarea id="rsaPublicKey" onchange="updateRSAKeys()" oninput="updateRSAKeys()"></textarea></td>
                <td><textarea id="rsaPrivateKey" onchange="updateRSAKeys()" oninput="updateRSAKeys()"></textarea></td>
            </tr>
            <tr>
                <td align="center"><button onclick="encryptRSA()">Encrypt</button></td>
                <td align="center"><button onclick="decryptRSA()">Decrypt</button></td>
            </tr>
            <tr>
                <td>Unencrypted text</td>
                <td>Encrypted text</td>
            </tr>
            <tr>
                <td><textarea id="rsaPlaintext"></textarea></td>
                <td><textarea id="rsaEncryptedText"></textarea></td>
            </tr>
        </table>

        <h2>AES</h2>
        <div>
            AES-256 CBC mode is compatible with C#.
            <br />
            <ul>C# counterparts:
                <li><a href="https://gist.github.com/therightstuff/30e5cbd9b1e0de1b8865c8fb6e2971e4" target="_blank">encrypt / decrypt functions</a></li>
            </ul>
        </div>
        <table>
                <tr>
                    <td align="right">Key: <input id="aesKey" /></td>
                    <td align="left"><button onclick="generateRandomKey()">Generate random key</button>
                </tr>
                <tr>
                    <td align="right">IV: <input id="aesIv" /></td>
                    <td align="left"><button onclick="generateIv()">Generate IV</button></td>
                </tr>
                <tr>
                    <td colspan="2" align="center">
                        <div id="aesSelectorDiv"></div>
                    </td>
                </tr>
                <tr class="aesFileOptions">
                        <td align="center"><button onclick="encryptAESFile()">Encrypt</button></td>
                        <td align="center"><button onclick="decryptAESFile()">Decrypt</button></td>
                </tr>
                <tr class="aesFileOptions">
                    <td colspan="2">Source File: <input type="file" id="aesSourceFile" /></td>
                </tr>
                <tr class="aesFileOptions">
                    <td colspan="2">Result File: <a id="aesResultFile" href="data:application/octet-stream;charset=utf-8;base64,Zm9vIGJhcg==">Download Result</a></td>
                </tr>    
                <tr class="aesTextOptions">
                    <td align="center"><button onclick="encryptAESText()">Encrypt</button></td>
                    <td align="center"><button onclick="decryptAESText()">Decrypt</button></td>
                </tr>
                <tr class="aesTextOptions">
                    <td>Unencrypted text</td>
                    <td>Encrypted text</td>
                </tr>
                <tr class="aesTextOptions">
                    <td><textarea id="aesPlaintext"></textarea></td>
                    <td><textarea id="aesEncryptedText"></textarea></td>
                </tr>
            </table>
    
        </center>
    </body>
</html>